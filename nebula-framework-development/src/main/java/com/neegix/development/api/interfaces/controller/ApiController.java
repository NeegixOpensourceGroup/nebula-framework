
package com.neegix.development.api.interfaces.controller;

import com.neegix.base.PageVO;
import com.neegix.cqrs.command.UniversalCommandBus;
import com.neegix.cqrs.query.UniversalQueryBus;
import com.neegix.development.api.application.service.command.DeleteApiCommand;
import com.neegix.development.api.application.service.command.UpdateApiCommand;
import com.neegix.development.api.application.service.command.mapper.ApiCommandMapper;
import com.neegix.development.api.application.service.query.GetApiDetailQuery;
import com.neegix.development.api.application.service.query.GetPageApiQuery;
import com.neegix.development.api.application.service.query.mapper.ApiQueryMapper;
import com.neegix.development.api.interfaces.form.CreateApiForm;
import com.neegix.development.api.interfaces.form.QueryApiForm;
import com.neegix.development.api.interfaces.form.UpdateApiForm;
import com.neegix.development.api.interfaces.vo.ApiListVO;
import com.neegix.development.api.interfaces.vo.ApiVO;
import com.neegix.inferfaces.result.Result;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

 /**
  * This file is auto-generated by nebula-framework-generator.
  * The auto-generation plugin was developed using IntelliJ IDEA Community Edition.
  * Thanks to JetBrains for their outstanding contributions to the developer community.
  * <p>
  * The code generated by this tool is owned by the user of the tool.
  * The tool itself is copyrighted by <a href="https://www.neegix.com">https://www.neegix.com</a>.
  *
  * @author <a href="https://www.neegix.com">https://www.neegix.com</a>
  * @version 1.0.0
  * @since 2024-11-22 11:43:14
  */

@RestController
@RequestMapping("/api/v1/api")
public class ApiController {

     @Autowired
     private UniversalCommandBus commandBus; // 注入通用CommandBus

     @Autowired
     private UniversalQueryBus queryBus;

    @PreAuthorize("hasAuthority('development:api:add')")
    @PostMapping
    public Result<Void> createApi(@RequestBody @Valid CreateApiForm createApiForm){
        Void result = commandBus.execute(ApiCommandMapper.INSTANCE.covertToCreateApiCommand(createApiForm));
        return Result.success("创建成功", result);
    }

    @PreAuthorize("hasAuthority('development:api:modify')")
    @PutMapping("/{id}")
    public Result<Void> updateApi(@PathVariable Long id, @RequestBody @Valid  UpdateApiForm apiForm){
        UpdateApiCommand command = ApiCommandMapper.INSTANCE.covertToUpdateApiCommand(apiForm);
        command.setId(id);
        Void result = commandBus.execute(command);
        return Result.success("更新成功",result);
    }

    @PreAuthorize("hasAuthority('development:api:list')")
    @GetMapping("/{currentPage}/{pageSize}")
    public Result<PageVO<ApiListVO>> getApis(@PathVariable("currentPage") Integer currentPage, @PathVariable("pageSize") Integer pageSize, @ModelAttribute QueryApiForm apiForm){
        GetPageApiQuery getPageApiQuery = ApiQueryMapper.INSTANCE.covertToGetPageApiQuery(apiForm);
        getPageApiQuery.setCurrentPage(currentPage);
        getPageApiQuery.setPageSize(pageSize);
        PageVO<ApiListVO> pageVO = queryBus.execute(getPageApiQuery);
        return Result.success("查询成功",pageVO);
    }

    @PreAuthorize("hasAuthority('development:api:get')")
    @GetMapping("/{id}")
    public Result<ApiVO> getApiById(@PathVariable("id") Long id) {
        GetApiDetailQuery detailQuery = new GetApiDetailQuery(id);
        return Result.success("获取成功", queryBus.execute(detailQuery));
    }

    @PreAuthorize("hasAuthority('development:api:remove')")
    @DeleteMapping
    public Result<Void> removeApi(@RequestBody List<Long> ids){
        DeleteApiCommand deleteApiCommand = new DeleteApiCommand();
        deleteApiCommand.setIds(ids);
        return Result.success("删除成功", commandBus.execute(deleteApiCommand));
    }
}